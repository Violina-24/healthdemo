<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meghalaya State Counselling Authority</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100">
<!-- Header Section -->
<header class="shadow-sm" style="background-color: darkblue;">
  <div class="ind-container pt-3 mb-0 w-100">
    <div class="d-flex align-items-start gap-4">
      <img src="/images/emblem.png" alt="National Emblem" class="emblem"/>
      <div class="w-100">
        <h1 class="fs-5 fw-semibold text-light mb-1">
          MEGHALAYA STATE COUNSELLING AUTHORITY FOR MEDICAL EDUCATION
        </h1>
        <p class="mb-0 text-light fs-6 fw-medium">GOVERNMENT OF MEGHALAYA</p>
      </div>
    </div>
  </div>
</header>

<!-- Navbar -->
<div class="navbar d-flex justify-content-start ps-3 shadow" style="margin-top: 0; padding-top: 0; padding-bottom:0; background-color: #004f98; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
  <a href="home" class="text-light fs-6 mx-2 text-decoration-none">Home</a>
  <a href="login" class="text-light fs-6 mx-2 text-decoration-none">Login</a>
</div>

<!--<div id="course-info" class="text-md font-semibold text-gray-700 mb-4"></div>-->

<!-- Form Container -->
<div class="container">
  <div class="bg-white rounded-3 shadow p-4 mx-auto" style="max-width: 800px;">
    <h2 class="text-center fw-bold mb-4 text-primary">Upload Your Documents</h2>

    <form id="fileUploadForm" enctype="multipart/form-data">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Aadhaar Linked Phone Number</label>
          <input type="tel" class="form-control" name="aadhaarPhone" id="aadhaarPhone" pattern="[6-9]{1}[0-9]{9}" maxlength="10" minlength="10" placeholder="Enter 10-digit mobile number" required>
          <small id="aadhaarPhoneInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Passport Size Photo</label>
          <input type="file" class="form-control" name="passportPhoto" id="passportPhoto" required>
          <small id="passportPhotoInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Birth Certificate or Other age proof</label>
          <input type="file" class="form-control" name="ageProof" id="ageProof" required>
          <small id="ageProofInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Class X and XII Marksheet</label>
          <input type="file" class="form-control" name="class10and12Marksheet" id="class10and12Marksheet" accept="application/pdf" required>
          <small id="class10and12MarksheetInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Class X and XII Pass Certificate</label>
          <input type="file" class="form-control" name="class10and12certificate" id="class10and12certificate" accept="application/pdf" required>
          <small id="class10and12certificateInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">NEET Result Sheet</label>
          <input type="file" class="form-control" name="neetResult" id="neetResult" required>
          <small id="neetResultInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6" id="casteCertificateSection">
          <label class="form-label fw-semibold">ST/SC/OST Certificate <small class="text-muted">(If applicable)</small></label>
          <input type="file" class="form-control" name="casteCertificate" id="casteCertificate">
          <small id="casteCertificateInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Permanent Residence Certificate (PRC)</label>
          <input type="file" class="form-control" name="prc" id="prc" required>
          <small id="prcInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Character Certificate</label>
          <input type="file" class="form-control" name="characterCertificate" id="characterCertificate" required>
          <small id="characterCertificateInfo" class="form-text text-success"></small>
        </div>
        <div class="col-md-6" id="pwdCertificateSection">
          <label class="form-label fw-semibold">PWD Certificate <small class="text-muted">(If applicable)</small></label>
          <input type="file" class="form-control" name="pwdCertificate" id="pwdCertificate">
          <small id="pwdCertificateInfo" class="form-text text-success"></small>
        </div>
      </div>

      <!-- Button Section -->
      <div class="d-flex justify-content-end align-items-center mt-4">
        <div class="btn-group gap-2">
          <button type="button" onclick="goBack()" class="btn btn-secondary px-4">Previous</button>
          <button type="button" id="previewButton" class="btn btn-primary px-4">Preview</button>
          <button class="btn btn-success" type="submit">Save and Submit</button>
        </div>
      </div>
    </form>
  </div>
</div>

<footer class="footer bg-dark text-white mt-auto py-4">
  <div class="text-center">
    <p class="mb-1">Â© 2025 Meghalaya State Counselling Authority. All rights reserved.</p>
    <p class="text-secondary mb-0">For technical support: support@meghalayamedical.gov.in</p>
  </div>
</footer>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const GlobalUserID = urlParams.get("uid");
  const userEmail = sessionStorage.getItem("userEmail") || "guest@example.com";
  const sessionKey = "fileUploadForm";


  document.addEventListener("DOMContentLoaded", function () {
  const selectedCourseId = localStorage.getItem("selectedCourseId");
  const selectedCourseName = localStorage.getItem("selectedCourseName");
  const selectedInstitute = localStorage.getItem("selectedInstitute");

  // Optional: Display message
  const courseInfoEl = document.getElementById("course-info");
  if (courseInfoEl && selectedCourseName && selectedInstitute) {
    courseInfoEl.innerText = `You are applying for ${selectedCourseName} at ${selectedInstitute}`;
  }

    const saved = JSON.parse(sessionStorage.getItem(sessionKey));
    if (saved) {
      document.getElementById("aadhaarPhone").value = saved.aadhaarPhone || "";

      for (const key in saved.files || {}) {
        const fileInfo = document.getElementById(`${key}Info`);
        if (fileInfo) {
          fileInfo.textContent = "File uploaded previously.";
        }
      }
    }
  });

  document.getElementById("previewButton").addEventListener("click", async function () {
    const aadhaarPhone = document.getElementById("aadhaarPhone").value;

    const fileFields = [
      "passportPhoto", "ageProof", "class10and12Marksheet", "class10and12certificate",
      "neetResult", "casteCertificate", "prc", "characterCertificate", "pwdCertificate"
    ];

    const filesData = {};
    for (let field of fileFields) {
      const fileInput = document.getElementById(field);
      const file = fileInput.files[0];
      if (file) {
        filesData[field] = await toBase64(file);
      }
    }

    const formData = {
      aadhaarPhone: aadhaarPhone,
      files: filesData
    };

    // Save everything to sessionStorage under one key
    sessionStorage.setItem(sessionKey, JSON.stringify(formData));

    // Navigate to preview (no need to store file data in another key)
    window.location.href = `/previewApplication?uid=${GlobalUserID}`;
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  document.getElementById("fileUploadForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Get all files as base64
    const fileFields = [
        "passportPhoto", "ageProof", "class10and12Marksheet", "class10and12certificate",
        "neetResult", "casteCertificate", "prc", "characterCertificate", "pwdCertificate"
    ];

    const filesData = {};
    for (let field of fileFields) {
        const fileInput = document.getElementById(field);
        if (fileInput.files[0]) {
            filesData[field] = await toBase64(fileInput.files[0]);
        }
    }

    const selectedCourseId = localStorage.getItem("selectedCourseId");
    const selectedCourseName = localStorage.getItem("selectedCourseName");
    const selectedInstitute = localStorage.getItem("selectedInstitute");

    const allFormsData = {
        studentformForm: JSON.parse(localStorage.getItem("studentformForm") || "{}")[userEmail],
        quotaForm: JSON.parse(localStorage.getItem("quotaForm") || "{}")[userEmail],
        qualificationForm: JSON.parse(localStorage.getItem("qualificationForm") || "{}")[userEmail],
        fileUploadForm: {
            aadhaarPhone: document.getElementById("aadhaarPhone").value,
            files: filesData
        },
        courseId: selectedCourseId,
        courseName: selectedCourseName,
        institute: selectedInstitute
};



    fetch("/application/save", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(allFormsData)
    })
    .then(response => {
        if (response.status === 401) {
            throw new Error("Session expired. Please login again.");
        }
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || "Submission failed"); });
        }
        return response.json();
    })
    .then(data => {
        const appId = data.applicationId;
        // Clear storage after successful submission
        localStorage.removeItem("studentformForm");
        localStorage.removeItem("quotaForm");
        localStorage.removeItem("qualificationForm");
        sessionStorage.removeItem("fileUploadForm");
        localStorage.removeItem("selectedCourseId");
        localStorage.removeItem("selectedCourseName");
        localStorage.removeItem("selectedInstitute");

        Swal.fire("Success", "Application submitted successfully!", "success")
            .then(() => window.location.href = `/application/applicationsuccess?applicationId=${appId}`);
    })
    .catch(error => {
        Swal.fire("Error", error.message, "error");
        if (error.message.includes("Session expired")) {
            window.location.href = "/login";
        }
    });
});
  window.goBack = function () {
    window.history.back();
  };
</script>


</body>
</html>
