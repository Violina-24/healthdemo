<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Admin Dashboard - MBBS Counselling</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/admin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        .course-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stats-card {
            min-height: 120px;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        .status-accepted {
            background-color: #28a745;
            color: #fff;
        }
        .status-rejected {
            background-color: #dc3545;
            color: #fff;
        }
        .application-list {
            display: none;
            margin-top: 20px;
        }
        .course-card.active + .application-list {
            display: block;
        }
    </style>
</head>
<body>
<!-- Admin Header -->
<header class="admin-header">
    <button class="toggle-sidebar" id="toggleSidebar">
        <i class="bi bi-list"></i>
    </button>
    <div class="user-profile">
        <img src="/images/avatar.jpg" alt="Admin Avatar" id="adminAvatar">
        <span id="adminName">Loading...</span>
        <a href="/api/logout" class="btn btn-sm btn-outline-danger ms-3">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>
</header>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <ul class="sidebar-menu">
        <li class="sidebar-item active" data-section="dashboard">
            <a href="#" class="sidebar-link" data-target="dashboard">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
        </li>
        <li class="sidebar-item" data-section="applications">
            <a href="#" class="sidebar-link" data-target="applications">
                <i class="bi bi-file-earmark-text"></i> Applications
            </a>
        </li>
        <li class="sidebar-item" data-section="reports">
            <a href="#" class="sidebar-link" data-target="reports">
                <i class="bi bi-graph-up"></i> Reports
            </a>
        </li>
        <li class="sidebar-item" data-section="uploadAdvt">
            <a href="#" class="sidebar-link" data-target="uploadAdvt">
                <i class="bi bi-megaphone"></i> Upload Advertisements
            </a>
        </li>
        <li class="sidebar-item" data-section="uploadAdmissions">
            <a href="#" class="sidebar-link" data-target="uploadAdmissions">
                <i class="bi bi-mortarboard"></i> Upload Ongoing Admissions
            </a>
        </li>
        <li class="sidebar-item" data-section="courses">
            <a href="#" class="sidebar-link" data-target="courses">
                <i class="bi bi-book"></i> Courses
            </a>
        </li>
    </ul>

    <div class="sidebar-footer">
        <a href="/login" class="logout-btn">
            <i class="bi bi-box-arrow-right me-2"></i>
            <span>Logout</span>
        </a>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Dashboard Section -->
    <div class="content-section active" id="dashboard-section">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Welcome, <span id="welcomeName">Admin</span></h3>
                <small class="text-muted" id="currentDate"></small>
            </div>


            <!--            not working-->

            <!-- Stats Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card stats-card text-white bg-primary" id="totalApplicationsCard">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Applications</h5>
                                    <h2 class="card-value" id="totalApplications">0</h2>
                                </div>
                                <i class="bi bi-file-earmark-text fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card text-white bg-success" id="acceptedApplicationsCard">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Accepted</h5>
                                    <h2 class="card-value" id="acceptedApplications">0</h2>
                                </div>
                                <i class="bi bi-check-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card text-white bg-danger" id="rejectedApplicationsCard">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Rejected</h5>
                                    <h2 class="card-value" id="rejectedApplications">0</h2>
                                </div>
                                <i class="bi bi-x-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card text-white bg-warning" id="totalCoursesCard">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Courses</h5>
                                    <h2 class="card-value" id="totalCourses">0</h2>
                                </div>
                                <i class="bi bi-book fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity need to fix this -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" id="activityList">
                        <!-- Activities will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Section -->
    <div class="content-section" id="applications-section">
        <div class="container-fluid">
            <h3 class="mb-4"><i class="bi bi-file-earmark-text me-2"></i>Applications</h3>

            <!-- Application Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card stats-card text-white bg-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Applications</h5>
                                    <h2 class="card-value" id="totalApplicationsCount">0</h2>
                                </div>
                                <i class="bi bi-file-earmark-text fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Accepted</h5>
                                    <h2 class="card-value" id="totalAcceptedCount">0</h2>
                                </div>
                                <i class="bi bi-check-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card text-white bg-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Rejected</h5>
                                    <h2 class="card-value" id="totalRejectedCount">0</h2>
                                </div>
                                <i class="bi bi-x-circle fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Cards -->
            <div class="row mb-4" id="courseCardsContainer">
                <!-- Course cards will be loaded here -->
            </div>
            <!-- Add this right before the applications table in your applications-section -->
            <div class="d-flex justify-content-end mb-3">
                <button id="closeApplicationsTable" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x-lg me-1"></i> Close Table
                </button>
            </div>

            <!-- Applications Table (shown by default for first course) -->
            <div class="card mt-4" id="applicationsTableContainer">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="applicationsTableTitle">Applications</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="filterAll">All</button>
                        <button type="button" class="btn btn-sm btn-outline-success" id="filterAccepted">Accepted</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="filterRejected">Rejected</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" id="filterPending">Pending</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Applicant Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Applied Date</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="applicationsTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center" id="applicationsPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>


    <!-- Reports Section have to work in this -->
    <div class="content-section" id="reports-section">
        <div class="container-fluid">
            <h3 class="mb-4"><i class="bi bi-graph-up me-2"></i>Reports</h3>

            <!-- Course Selection Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Generate Merit Lists</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Course Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="reportCourseSelect" class="form-label">Select Course</label>
                            <select class="form-select" id="reportCourseSelect">
                                <option value="">-- Select Course --</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>

                        <!-- Institute Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="reportInstituteSelect" class="form-label">Select Institute</label>
                            <select class="form-select" id="reportInstituteSelect" disabled>
                                <option value="">-- Select Institute --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center mt-3">
                        <button id="generateMeritListBtn" class="btn btn-primary" disabled>
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Merit List
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Reports Card -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Reports</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Report Date</th>
                                <th>Course</th>
                                <th>Institute</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="recentReportsTable">
                            <!-- Will be populated by JavaScript -->
                            <tr>
                                <td colspan="5" class="text-center py-4">No reports generated yet</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload Advertisement Section make it work-->
    <div class="content-section" id="uploadAdvt-section">
        <div class="container-fluid">
            <h3 class="mb-4"><i class="bi bi-megaphone me-2"></i>Upload Advertisement</h3>
            <div class="form-container">
                <div class="form-header">
                    <h5>New Advertisement</h5>
                    <p class="text-muted mb-0">Fill the form to upload a new advertisement</p>
                </div>
                <form id="advtForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="advtNo" class="form-label">Advertisement Number</label>
                            <input type="text" class="form-control" id="advtNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="advtDate" class="form-label">Advertisement Date</label>
                            <input type="date" class="form-control" id="advtDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="advtDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="advtDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="courseSelect" class="form-label">Select Course (Optional)</label>
                        <select class="form-select" id="courseSelect">
                            <option value="">-- No specific course --</option>
                            <!-- Courses will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="advtOpenDate" class="form-label">Open Date</label>
                            <input type="date" class="form-control" id="advtOpenDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="advtEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="advtEndDate" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="advtFile" class="form-label">Advertisement File (PDF)</label>
                        <input type="file" class="form-control" id="advtFile" accept=".pdf" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="reset" class="btn btn-outline-secondary me-2">Reset</button>
                        <button type="submit" class="btn btn-primary">Upload Advertisement</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Upload Ongoing Admissions Section make it work -->
    <div class="content-section" id="uploadAdmissions-section">
        <div class="container-fluid">
            <h3 class="mb-4"><i class="bi bi-mortarboard me-2"></i>Upload Ongoing Admissions</h3>
            <div class="form-container">
                <div class="form-header">
                    <h5>New Admission Notice</h5>
                    <p class="text-muted mb-0">Fill the form to upload a new admission notice</p>
                </div>
                <form id="admissionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="admissionNo" class="form-label">Admission Notice Number</label>
                            <input type="text" class="form-control" id="admissionNo" required>
                        </div>
                        <div class="col-md-6">
                            <label for="admissionDate" class="form-label">Notice Date</label>
                            <input type="date" class="form-control" id="admissionDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="admissionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="admissionDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="admissionCourseSelect" class="form-label">Select Course</label>
                        <select class="form-select" id="admissionCourseSelect" required>
                            <option value="">-- Select a course --</option>
                            <!-- Courses will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="admissionOpenDate" class="form-label">Open Date</label>
                            <input type="date" class="form-control" id="admissionOpenDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="admissionEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="admissionEndDate" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="admissionFile" class="form-label">Admission Notice File (PDF)</label>
                        <input type="file" class="form-control" id="admissionFile" accept=".pdf" required>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="reset" class="btn btn-outline-secondary me-2">Reset</button>
                        <button type="submit" class="btn btn-primary">Upload Admission Notice</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--couse section need to fix the ui-->
    <div class="content-section" id="courses-section">
        <div class="container-fluid">
            <h3 class="mb-4"><i class="bi bi-book me-2"></i>Manage Courses</h3>

            <div class="card mb-4">
                <div class="card-header">
                    <h5>Add New Course</h5>
                </div>
                <div class="card-body">
                    <form id="courseForm" class="course-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="courseName" class="form-label">Course Name</label>
                                <input type="text" class="form-control" id="courseName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="instituteName" class="form-label">Institute</label>
                                <input type="text" class="form-control" id="instituteName" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="courseDuration" class="form-label">Duration (years)</label>
                                <input type="number" class="form-control" id="courseDuration" required>
                            </div>
                            <div class="col-md-6">
                                <label for="courseSeats" class="form-label">Total Seats</label>
                                <input type="number" class="form-control" id="courseSeats" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="courseDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="courseDescription" rows="3"></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="reset" class="btn btn-outline-secondary me-2">Reset</button>
                            <button type="submit" class="btn btn-primary">Add Course</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Courses</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search courses..." id="courseSearch">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table course-table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Course Name</th>
                                <th>Institute</th>
                                <th>Duration</th>
                                <th>Seats</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                            <!-- Courses will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center" id="coursesPagination">
                            <!-- Pagination will be loaded here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Application Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Application Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body preview-modal">
                <iframe id="applicationPreviewFrame" src="about:blank"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="acceptFromPreview">Accept</button>
                <button type="button" class="btn btn-danger" id="rejectFromPreview">Reject</button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer bg-dark text-white py-3">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <p class="mb-0">© 2025 Meghalaya State Counselling Authority. All rights reserved.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="mb-0">Admin Dashboard v1.1.0</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global variables
    let currentAdmin = {};
    let applications = [];
    let currentApplicationPage = 1;
    const applicationsPerPage = 10;
    let courses = [];
    let currentCoursePage = 1;
    const coursesPerPage = 5;
    let currentCourseFilter = 'all';
    let applicationsByCourse = {};
    let currentlySelectedCourse = null;

 // Replace the entire DOMContentLoaded event listener with this:
document.addEventListener('DOMContentLoaded', function() {
    // Check admin role
    const userRole = sessionStorage.getItem('userRole');
    if (userRole !== 'admin') {
        window.location.href = '/login';
        return;
    }

    // Initialize admin data
    loadAdminData();
    updateCurrentDate();
    setupSidebar();
    setupForms();
    setupModalEvents();

    // Safe event listener for close button
    const closeBtn = document.getElementById('closeApplicationsTable');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            document.getElementById('applicationsTableContainer').classList.remove('active');
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('active');
            });
            currentlySelectedCourse = null;
        });
    } else {
        console.warn('Close applications table button not found');
    }

    // Make Total Courses card clickable (with null check)
    const totalCoursesCard = document.getElementById('totalCoursesCard');
    if (totalCoursesCard) {
        totalCoursesCard.addEventListener('click', function() {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show courses section
            document.getElementById('courses-section').classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.classList.remove('active');
            });
        });
    }

    // Load initial data
    loadCourses()
        .then(() => {
            initReportsSection();
            return Promise.all([
                loadApplications(),
                loadCourseApplicationStats(),
                loadActivities()
            ]);
        })
        .catch(error => {
            console.error('Initialization error:', error);
            // Try to initialize reports section anyway
            initReportsSection();
        });
});

        // Make Total Courses card clickable
        document.getElementById('totalCoursesCard').addEventListener('click', function() {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show courses section
            document.getElementById('courses-section').classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.classList.remove('active');
            });
        });

    // Load admin data
    function loadAdminData() {
        // In a real app, you would fetch this from your API
        const adminEmail = sessionStorage.getItem('userEmail');
        const adminId = sessionStorage.getItem('userId');

        // For demo purposes, we'll use mock data
        currentAdmin = {
            id: adminId,
            name: "Admin User",
            email: adminEmail,
            role: "admin"
        };

        // Update UI
        document.getElementById('adminName').textContent = currentAdmin.name;
        document.getElementById('welcomeName').textContent = currentAdmin.name;
    }

    // Update current date
    function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const today = new Date();
        document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
    }

    // Setup sidebar navigation
    function setupSidebar() {
    // Toggle sidebar on mobile
    document.getElementById('toggleSidebar').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.main-content').classList.toggle('sidebar-collapsed');
    });

    // Handle sidebar menu clicks
    const menuItems = document.querySelectorAll('.sidebar-item');
    const sidebarLinks = document.querySelectorAll('.sidebar-link');

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = this.getAttribute('data-target');

            // Update active state
            menuItems.forEach(item => item.classList.remove('active'));
            this.parentElement.classList.add('active');

            // Show corresponding section
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            const targetElement = document.getElementById(`${targetSection}-section`);
            if (targetElement) {
                targetElement.classList.add('active');

                // Load data if needed
                if (targetSection === 'applications') {
                    loadApplications();
                } else if (targetSection === 'courses') {
                    loadCourses();
                }
            }
        });
    });

    // Handle logout confirmation
    document.querySelector('.logout-btn').addEventListener('click', function(e) {
        if (!confirm('Are you sure you want to logout?')) {
            e.preventDefault();
        }
    });
}

    // Setup forms
    function setupForms() {
        // Advertisement form
        document.getElementById('advtForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadAdvertisement();
        });

        // Admission form
        document.getElementById('admissionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            uploadAdmission();
        });

        // Course form
    document.getElementById('courseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addCourse();
    });
    }

    // Load applications from API
 function loadApplications(page = 1, courseId = null) {
    currentApplicationPage = page;

    // If no courseId provided and we have courses, use the first one
    if (!courseId && courses.length > 0) {
        courseId = courses[0].courseid || courses[0].id;
        currentlySelectedCourse = courseId;
    } else if (courseId) {
        currentlySelectedCourse = courseId;
    }

    let url = '/application/applications';
    if (courseId && courseId !== 'all') {
        url = `/application/applications?courseId=${courseId}`;
    }

    return fetch(url, {
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401) {
            window.location.href = '/login';
            throw new Error('Unauthorized');
        }
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        applications = data;
        renderApplicationsTable();
        renderApplicationsPagination();

        // Update the table title with course name if applicable
        if (courseId && courseId !== 'all') {
            const course = courses.find(c => (c.courseid || c.id) == courseId);
            if (course) {
                document.getElementById('applicationsTableTitle').textContent =
                    `Applications for ${course.coursename || course.name}`;
            }
        } else {
            document.getElementById('applicationsTableTitle').textContent = 'All Applications';
        }

        return applications;
    })
    .catch(error => {
        console.error('Error loading applications:', error);
        if (error.message !== 'Unauthorized') {
            showAlert(`Failed to load applications: ${error.message}`, 'danger');
        }
        return [];
    });
}

function renderApplicationsPagination() {
    const paginationContainer = document.getElementById('applicationsPagination');
    if (!paginationContainer) {
        console.error('Pagination container not found');
        return;
    }

    paginationContainer.innerHTML = '';

    const totalPages = Math.ceil(applications.length / applicationsPerPage);
    if (totalPages <= 1) return; // Don't show pagination if only one page

    // Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentApplicationPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                       </a>`;
    prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentApplicationPage > 1) {
            loadApplications(currentApplicationPage - 1, currentCourseFilter);
        }
    });
    paginationContainer.appendChild(prevLi);

    // Page Numbers
    const maxVisiblePages = 5; // Show up to 5 page numbers
    let startPage, endPage;

    if (totalPages <= maxVisiblePages) {
        startPage = 1;
        endPage = totalPages;
    } else {
        const maxPagesBeforeCurrent = Math.floor(maxVisiblePages / 2);
        const maxPagesAfterCurrent = Math.ceil(maxVisiblePages / 2) - 1;

        if (currentApplicationPage <= maxPagesBeforeCurrent) {
            startPage = 1;
            endPage = maxVisiblePages;
        } else if (currentApplicationPage + maxPagesAfterCurrent >= totalPages) {
            startPage = totalPages - maxVisiblePages + 1;
            endPage = totalPages;
        } else {
            startPage = currentApplicationPage - maxPagesBeforeCurrent;
            endPage = currentApplicationPage + maxPagesAfterCurrent;
        }
    }

    // Add page number buttons
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentApplicationPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageLi.addEventListener('click', (e) => {
            e.preventDefault();
            loadApplications(i, currentCourseFilter);
        });
        paginationContainer.appendChild(pageLi);
    }

    // Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentApplicationPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                       </a>`;
    nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentApplicationPage < totalPages) {
            loadApplications(currentApplicationPage + 1, currentCourseFilter);
        }
    });
    paginationContainer.appendChild(nextLi);
}


// Add this new function to load course statistics
function loadCourseApplicationStats() {
        return fetch('/application/applications/course-stats', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            applicationsByCourse = data;

            // Update total counts
            document.getElementById('totalApplicationsCount').textContent = data.all?.total || 0;
            document.getElementById('totalAcceptedCount').textContent = data.all?.accepted || 0;
            document.getElementById('totalRejectedCount').textContent = data.all?.rejected || 0;

            renderCourseCards();
            return data;
        })
        .catch(error => {
            console.error('Error loading course stats:', error);
            // Fallback to mock data
            applicationsByCourse = {
                'all': { total: 45, accepted: 15, rejected: 5 },
                '1': { total: 20, accepted: 10, rejected: 2 },
                '2': { total: 15, accepted: 3, rejected: 2 },
                '3': { total: 10, accepted: 2, rejected: 1 }
            };

            // Update total counts with mock data
            document.getElementById('totalApplicationsCount').textContent = applicationsByCourse.all.total;
            document.getElementById('totalAcceptedCount').textContent = applicationsByCourse.all.accepted;
            document.getElementById('totalRejectedCount').textContent = applicationsByCourse.all.rejected;

            renderCourseCards();
            return applicationsByCourse;
        });
    }
    function renderCourseCards() {
    const container = document.getElementById('courseCardsContainer');
    if (!container) return;

    container.innerHTML = '';

    // Add cards for each course
    courses.forEach((course, index) => {
        if (!course || (course.courseid == null && course.id == null)) {
            console.warn('Invalid course found:', course);
            return;
        }

        const courseId = String(course.courseid || course.id);
        const stats = applicationsByCourse[courseId] || { total: 0, accepted: 0, rejected: 0 };
        const courseName = course.coursename || course.name || 'Unnamed Course';
        const instituteName = course.institute || 'Unknown Institute';

        const card = document.createElement('div');
        card.className = `col-md-4 mb-4 course-card ${currentlySelectedCourse === courseId ? 'active' : ''}`;
        card.dataset.courseId = courseId;
        card.innerHTML = `
            <div class="card h-100" style="border-left: 5px solid ${getCourseColor(courseId)}">
                <div class="card-body">
                    <h5 class="card-title">${courseName}</h5>
                    <p class="card-subtitle text-muted mb-3">${instituteName}</p>

                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-primary">
                                <div class="h4 mb-0">${stats.total}</div>
                                <small>Total</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-success">
                                <div class="h4 mb-0">${stats.accepted}</div>
                                <small>Accepted</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-danger">
                                <div class="h4 mb-0">${stats.rejected}</div>
                                <small>Rejected</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">Click to view applications</small>
                </div>
            </div>
        `;

        card.addEventListener('click', () => {
            // Set current course filter
            currentlySelectedCourse = courseId;

            // Load applications for this course
            loadApplications(1, courseId);

            // Update active state
            document.querySelectorAll('.course-card').forEach(c => {
                c.classList.remove('active');
            });
            card.classList.add('active');
        });

        // If this is the first course and no course is selected, make it active
        if (index === 0 && !currentlySelectedCourse) {
            card.classList.add('active');
            currentlySelectedCourse = courseId;
            loadApplications(1, courseId);
        }

        container.appendChild(card);
    });
}

// Add filter event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('filterAll').addEventListener('click', () => {
        // Just reload normally with pagination
        loadApplications(1, currentlySelectedCourse);
    });
    document.getElementById('filterAccepted').addEventListener('click', () => filterApplications('accepted'));
    document.getElementById('filterRejected').addEventListener('click', () => filterApplications('rejected'));
    document.getElementById('filterPending').addEventListener('click', () => filterApplications('pending'));
});

            // Helper function for course colors
    function getCourseColor(courseId) {
        const colors = ['#6c757d', '#28a745', '#17a2b8', '#ffc107', '#dc3545'];
        return colors[courseId % colors.length];
    }

// Update the renderCourseFilters function
function renderCourseFilters() {
    const container = document.getElementById('courseFilters');
    if (!container) return;

    container.innerHTML = '';

    // Add buttons for each course
    courses.forEach(course => {
        if (!course || course.courseid == null) {
            console.warn('Invalid course found:', course);
            return;
        }

        const courseId = String(course.courseid);
        const stats = applicationsByCourse[courseId] || { total: 0, accepted: 0, rejected: 0 };
        const courseName = course.coursename || 'Unnamed Course';
        const instituteName = course.institute || 'Unknown Institute';

        const card = document.createElement('div');
        card.className = `col-md-3 mb-3 course-filter ${currentCourseFilter === courseId ? 'active' : ''}`;
        card.innerHTML = `
            <div class="card stats-card text-white"
                 style="background-color: ${getCourseColor(courseId)}"
                 data-course="${courseId}">
                <div class="card-body">
                    <h5 class="card-title">${courseName}</h5>
                    <p class="card-subtitle mb-2 text-white-50">${instituteName}</p>
                    <div class="d-flex justify-content-between">
                        <span>Total: ${stats.total}</span>
                        <span class="text-success">✓ ${stats.accepted}</span>
                        <span class="text-danger">✗ ${stats.rejected}</span>
                    </div>
                </div>
            </div>
        `;
        card.addEventListener('click', () => {
            currentCourseFilter = courseId;
            document.getElementById('applicationsTableTitle').textContent = `Applications for ${courseName}`;
            loadApplications(1, courseId);
        });
        container.appendChild(card);
    });
    }
debugger;
// Add this function to render course filter buttons
function renderCourseFilters() {
    const container = document.getElementById('courseFilters');
    if (!container) return;

    container.innerHTML = '';

    // Add "All Courses" button
    const allCard = document.createElement('div');
    allCard.className = `col-md-3 mb-3 course-filter ${currentCourseFilter === 'all' ? 'active' : ''}`;
    allCard.innerHTML = `
        <div class="card stats-card text-white bg-primary" data-course="all">
            <div class="card-body">
                <h5 class="card-title">All Courses</h5>
                <div class="d-flex justify-content-between">
                    <span>Total: ${applicationsByCourse['all']?.total || 0}</span>
                    <span class="text-success">✓ ${applicationsByCourse['all']?.accepted || 0}</span>
                    <span class="text-danger">✗ ${applicationsByCourse['all']?.rejected || 0}</span>
                </div>
            </div>
        </div>
    `;
    allCard.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent default behavior
        currentCourseFilter = 'all';
        document.getElementById('applicationsTableTitle').textContent = 'All Applications';
        loadApplications(1, 'all');
    });
    container.appendChild(allCard);

    // Add buttons for each course
    courses.forEach(course => {
        if (!course || course.courseid == null) {
            console.warn('Invalid course found:', course);
            return;
        }

        const courseId = String(course.courseid);
        const stats = applicationsByCourse[courseId] || { total: 0, accepted: 0, rejected: 0 };
        const courseName = course.coursename || 'Unnamed Course';
        const instituteName = course.institute || 'Unknown Institute';

        const card = document.createElement('div');
        card.className = `col-md-3 mb-3 course-filter ${currentCourseFilter === courseId ? 'active' : ''}`;
        card.innerHTML = `
            <div class="card stats-card text-white"
                 style="background-color: ${getCourseColor(courseId)}"
                 data-course="${courseId}">
                <div class="card-body">
                    <h5 class="card-title">${courseName}</h5>
                    <p class="card-subtitle mb-2 text-white-50">${instituteName}</p>
                    <div class="d-flex justify-content-between">
                        <span>Total: ${stats.total}</span>
                        <span class="text-success">✓ ${stats.accepted}</span>
                        <span class="text-danger">✗ ${stats.rejected}</span>
                    </div>
                </div>
            </div>
        `;
        card.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default behavior
            currentCourseFilter = courseId;
            document.getElementById('applicationsTableTitle').textContent = `Applications for ${courseName}`;
            loadApplications(1, courseId);
        });
        container.appendChild(card);
    });
}
// Helper function for course colors
function getCourseColor(courseId) {
    const colors = ['#6c757d', '#28a745', '#17a2b8', '#ffc107', '#dc3545'];
    return colors[courseId % colors.length];
}

   // Load courses from API
// Fixed loadCourses function to always return a Promise
    function loadCourses(page = 1) {
    currentCoursePage = page;

    return fetch('/courses', {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        // Ensure data is an array and has expected properties
        courses = Array.isArray(data) ? data.map(course => {
            // Normalize course properties
            return {
                id: course.id || course.courseid,
                courseid: course.courseid || course.id,
                name: course.name || course.coursename,
                coursename: course.coursename || course.name,
                institute: course.institute || 'Unknown Institute',
                // Include any other necessary properties
                ...course
            };
        }) : [];

        console.log('Courses loaded:', courses); // Debug log
        updateCourseStats();
        renderCoursesTable();
        renderCoursesPagination();
        return courses;
    })
    .catch(error => {
        console.error('Error loading courses:', error);
        // Fallback to mock data
        courses = generateMockCourses();
        updateCourseStats();
        renderCoursesTable();
        renderCoursesPagination();
        return courses;
    });
}
// Generate mock courses (fallback)
function generateMockCourses() {
    const mockCourses = [
        { id: 1, courseid: 1, name: "MBBS", coursename: "MBBS", institute: "SMC" },
        { id: 2, courseid: 2, name: "BDS", coursename: "BDS", institute: "Dental College" },
        { id: 3, courseid: 3, name: "BAMS", coursename: "BAMS", institute: "PIMC" }
    ];
    console.log('Using mock courses:', mockCourses); // Debug log
    return mockCourses;
}

    // Update course stats
function updateCourseStats() {
    document.getElementById('totalCourses').textContent = courses.length;
}

// Render courses table
function renderCoursesTable() {
    const tableBody = document.getElementById('coursesTableBody');
    tableBody.innerHTML = '';

    // Ensure courses is an array
    if (!Array.isArray(courses)) {
        console.error('Courses is not an array:', courses);
        courses = []; // Reset to empty array
        return; // Exit early
    }

    // Calculate pagination
    const startIndex = (currentCoursePage - 1) * coursesPerPage;
    const endIndex = Math.min(startIndex + coursesPerPage, courses.length);
    const pageCourses = courses.slice(startIndex, endIndex);

    pageCourses.forEach(course => {
        // Add null checks for course properties
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${course?.id || ''}</td>
            <td>${course?.name || ''}</td>
            <td>${course?.institute || ''}</td>
            <td>${course?.duration || 'N/A'} years</td>
            <td>${course?.seats || 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1 edit-course" data-id="${course?.id || ''}">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-course" data-id="${course?.id || ''}">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // Add event listeners
    document.querySelectorAll('.edit-course').forEach(btn => {
        btn.addEventListener('click', function() {
            const courseId = parseInt(this.getAttribute('data-id'));
            editCourse(courseId);
        });
    });

    document.querySelectorAll('.delete-course').forEach(btn => {
        btn.addEventListener('click', function() {
            const courseId = parseInt(this.getAttribute('data-id'));
            deleteCourse(courseId);
        });
    });
}

// Render courses pagination
function renderCoursesPagination() {
    const totalPages = Math.ceil(courses.length / coursesPerPage);
    const pagination = document.getElementById('coursesPagination');
    pagination.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentCoursePage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
    prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentCoursePage > 1) {
            loadCourses(currentCoursePage - 1);
        }
    });
    pagination.appendChild(prevLi);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentCoursePage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageLi.addEventListener('click', (e) => {
            e.preventDefault();
            loadCourses(i);
        });
        pagination.appendChild(pageLi);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentCoursePage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
    nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentCoursePage < totalPages) {
            loadCourses(currentCoursePage + 1);
        }
    });
    pagination.appendChild(nextLi);
}

// Add new course
function addCourse() {
    const courseData = {
        name: document.getElementById('courseName').value,
        institute: document.getElementById('instituteName').value,
        duration: parseInt(document.getElementById('courseDuration').value),
        seats: parseInt(document.getElementById('courseSeats').value)
    };

    fetch('/api/courses', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(courseData)
    })
    .then(response => response.json())
    .then(newCourse => {
        courses.unshift(newCourse); // Add to beginning
        updateCourseStats();
        renderCoursesTable();
        renderCoursesPagination();
        document.getElementById('courseForm').reset();
        addActivity(`Added new course: ${newCourse.name}`);
    })
    .catch(error => {
        console.error('Error adding course:', error);
        // Fallback to client-side
        const newCourse = {
            id: courses.length > 0 ? Math.max(...courses.map(c => c.id)) + 1 : 1,
            ...courseData
        };
        courses.unshift(newCourse);
        updateCourseStats();
        renderCoursesTable();
        renderCoursesPagination();
        document.getElementById('courseForm').reset();
        addActivity(`Added new course: ${newCourse.name}`);
    });
}

// Edit course
function editCourse(courseId) {
    const course = courses.find(c => c.id === courseId);
    if (course) {
        document.getElementById('courseName').value = course.name;
        document.getElementById('instituteName').value = course.institute;
        document.getElementById('courseDuration').value = course.duration;
        document.getElementById('courseSeats').value = course.seats;


        const form = document.getElementById('courseForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Update Course';

        // Remove previous event listeners
        form.onsubmit = null;

        // Add update handler
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            updateCourse(courseId);
        });
    }
}

// Update course
function updateCourse(courseId) {
    const courseData = {
        name: document.getElementById('courseName').value,
        institute: document.getElementById('instituteName').value,
        duration: parseInt(document.getElementById('courseDuration').value),
        seats: parseInt(document.getElementById('courseSeats').value),
        description: document.getElementById('courseDescription').value
    };

    fetch(`/api/courses/${courseId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(courseData)
    })
    .then(response => {
        if (response.ok) {
            const index = courses.findIndex(c => c.id === courseId);
            if (index !== -1) {
                courses[index] = { id: courseId, ...courseData };
                renderCoursesTable();
                resetCourseForm();
                addActivity(`Updated course: ${courseData.name}`);
            }
        }
    })
    .catch(error => {
        console.error('Error updating course:', error);
        // Fallback to client-side
        const index = courses.findIndex(c => c.id === courseId);
        if (index !== -1) {
            courses[index] = { id: courseId, ...courseData };
            renderCoursesTable();
            resetCourseForm();
            addActivity(`Updated course: ${courseData.name}`);
        }
    });
}

// Delete course
function deleteCourse(courseId) {
    if (confirm('Are you sure you want to delete this course?')) {
        fetch(`/api/courses/${courseId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                courses = courses.filter(c => c.id !== courseId);
                updateCourseStats();
                renderCoursesTable();
                renderCoursesPagination();
                addActivity(`Deleted course ID: ${courseId}`);
            }
        })
        .catch(error => {
            console.error('Error deleting course:', error);
            // Fallback to client-side
            courses = courses.filter(c => c.id !== courseId);
            updateCourseStats();
            renderCoursesTable();
            renderCoursesPagination();
            addActivity(`Deleted course ID: ${courseId}`);
        });
    }
}

// Reset course form
function resetCourseForm() {
    document.getElementById('courseForm').reset();
    const form = document.getElementById('courseForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Add Course';

    // Remove previous event listeners
    form.onsubmit = null;

    // Add submit handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        addCourse();
    });
}

function safeAddEventListener(elementId, eventType, handler) {
    const element = document.getElementById(elementId);
    if (element) {
        element.addEventListener(eventType, handler);
    } else {
        console.warn(`Element with ID ${elementId} not found for event listener`);
    }
}
    // Update application stats
function renderApplicationsTable() {
    const tableBody = document.getElementById('applicationsTableBody');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    if (!applications.length) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
                    No applications found ${currentCourseFilter !== 'all' ? 'for this course' : ''}
                </td>
            </tr>
        `;
        return;
    }

    const startIndex = (currentApplicationPage - 1) * applicationsPerPage;
    const endIndex = Math.min(startIndex + applicationsPerPage, applications.length);
    const pageApplications = applications.slice(startIndex, endIndex);

    pageApplications.forEach(app => {
        const row = document.createElement('tr');
        const status = app.status || 'pending';
        const statusDisplay = status.charAt(0).toUpperCase() + status.slice(1);

        row.innerHTML = `
            <td>${app.id || 'N/A'}</td>
            <td>${app.applicantName || 'N/A'}</td>
            <td>${app.email || 'N/A'}</td>
            <td>${app.category || 'N/A'}</td>
            <td>${app.neetScore || 'N/A'}</td>
            <td>${app.quota || (app.managementQuota ? 'Management' : 'Regular')}</td>
            <td><span class="status-badge status-${status}">${statusDisplay}</span></td>
            <td>${app.appliedDate ? new Date(app.appliedDate).toLocaleDateString() : 'N/A'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success accept-btn" data-id="${app.id}">
                        <i class="bi bi-check-lg"></i> Accept
                    </button>
                    <button class="btn btn-outline-danger reject-btn" data-id="${app.id}">
                        <i class="bi bi-x-lg"></i> Reject
                    </button>
                    <button class="btn btn-outline-primary preview-btn" data-id="${app.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // Add event delegation for buttons
    tableBody.addEventListener('click', handleTableButtonClick);
}

    function handleTableButtonClick(event) {
        const target = event.target;

        // Handle Accept button
        if (target.closest('.accept-btn')) {
            const appId = parseInt(target.closest('.accept-btn').getAttribute('data-id'));
            updateApplicationStatus(appId, 'accepted');
        }

        // Handle Reject button
        if (target.closest('.reject-btn')) {
            const appId = parseInt(target.closest('.reject-btn').getAttribute('data-id'));
            updateApplicationStatus(appId, 'rejected');
        }

        // Handle Preview button
        if (target.closest('.preview-btn')) {
            const appId = parseInt(target.closest('.preview-btn').getAttribute('data-id'));
            previewApplication(appId);
        }
    }


    // Filter applications
  function filterApplications(status) {
    // Show loading state
    const tableBody = document.getElementById('applicationsTableBody');
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Loading applications...</td></tr>';

    // Get all applications (without pagination)
    let url = '/application/applications';
    if (currentlySelectedCourse && currentlySelectedCourse !== 'all') {
        url += `?courseId=${currentlySelectedCourse}`;
    }

    fetch(url, {
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch applications');
        return response.json();
    })
    .then(allApplications => {
        // Filter applications based on status
        let filteredApplications = allApplications;
        if (status !== 'all') {
            filteredApplications = allApplications.filter(app =>
                (app.status || 'pending').toLowerCase() === status.toLowerCase()
            );
        }

        // Render all filtered applications at once (without pagination)
        renderFilteredApplications(filteredApplications, status);
    })
    .catch(error => {
        console.error('Error filtering applications:', error);
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">Error loading applications: ${error.message}</td></tr>`;
    });
}

function renderFilteredApplications(filteredApplications, status) {
    const tableBody = document.getElementById('applicationsTableBody');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    if (!filteredApplications.length) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    No ${status} applications found
                </td>
            </tr>
        `;
        return;
    }

    filteredApplications.forEach(app => {
        const row = document.createElement('tr');
        const statusText = app.status || 'pending';
        const statusDisplay = statusText.charAt(0).toUpperCase() + statusText.slice(1);

        row.innerHTML = `
            <td>${app.id || 'N/A'}</td>
            <td>${app.applicantName || 'N/A'}</td>
            <td>${app.email || 'N/A'}</td>
            <td><span class="status-badge status-${statusText}">${statusDisplay}</span></td>
            <td>${app.appliedDate ? new Date(app.appliedDate).toLocaleDateString() : 'N/A'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success accept-btn" data-id="${app.id}">
                        <i class="bi bi-check-lg"></i> Accept
                    </button>
                    <button class="btn btn-outline-danger reject-btn" data-id="${app.id}">
                        <i class="bi bi-x-lg"></i> Reject
                    </button>
                    <button class="btn btn-outline-primary preview-btn" data-id="${app.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // Hide pagination when filtering
    const paginationContainer = document.getElementById('applicationsPagination');
    if (paginationContainer) {
        paginationContainer.style.display = 'none';
    }

    // Add a "Back to all" button
    const actionsRow = document.createElement('tr');
    actionsRow.innerHTML = `
        <td colspan="6" class="text-center">
            <button class="btn btn-outline-secondary" id="resetFilterBtn">
                <i class="bi bi-arrow-left"></i> Back to all applications
            </button>
        </td>
    `;
    tableBody.appendChild(actionsRow);

    // Add event listener for the reset button
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        // Show pagination again
        if (paginationContainer) {
            paginationContainer.style.display = '';
        }
        // Reload applications with pagination
        loadApplications(1, currentlySelectedCourse);
    });
}



// Update application status
    function updateApplicationStatus(appId, newStatus) {
        if (!confirm(`Are you sure you want to ${newStatus} this application?`)) {
            return;
        }

        fetch(`/application/applications/${appId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus }),
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to update status');
            return response.json();
        })
        .then(updatedApp => {
            // Update local state
            const appIndex = applications.findIndex(app => app.id === appId);
            if (appIndex !== -1) {
                applications[appIndex].status = newStatus;
            }

            // Reload applications to reflect changes
            loadApplications(currentApplicationPage, currentCourseFilter);
            loadCourseApplicationStats(); // Refresh stats

            // Show success
            showAlert(`Status updated to ${newStatus}`, 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to update status', 'danger');
        });
    }

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    // Try multiple possible container locations
    const container = document.getElementById('alertContainer') ||
                     document.querySelector('.form-container') ||
                     document.querySelector('.main-content > .container-fluid') ||
                     document.body;

    // Clear existing alerts
    const existingAlerts = container.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());

    // Add new alert
    container.insertAdjacentElement('afterbegin', alertDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

  // Updated previewApplication function
// Updated previewApplication function
function previewApplication(appId, isAdmin = false) {
    const endpoint = isAdmin ?
        `/application/admin/applications/${appId}/full` :
        `/application/applications/${appId}/full`;

    fetch(endpoint, {
        credentials: 'include' // Keep this for consistency
    })
    .then(response => {
        if (!response.ok) {
            // Handle 404 (not found) differently from server errors
            if (response.status === 404) {
                throw new Error('Application not found');
            }
            throw new Error(`Server returned ${response.status} status`);
        }
        return response.json();
    })
    .then(application => {
        // Create or get modal
        let modal = document.getElementById('applicationPreviewModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'applicationPreviewModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Application Details - ID: ${application.id || application.A_id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="applicationPreviewContent">
                            <!-- Content will be loaded here -->
                        </div>
                        <div class="modal-footer">
                            ${isAdmin ? `
                            <button type="button" class="btn btn-success" id="acceptFromPreview" data-id="${appId}">
                                <i class="bi bi-check-lg"></i> Accept
                            </button>
                            <button type="button" class="btn btn-danger" id="rejectFromPreview" data-id="${appId}">
                                <i class="bi bi-x-lg"></i> Reject
                            </button>
                            ` : ''}
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Format dates
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN');
        };

        // Set the modal content
        const content = document.getElementById('applicationPreviewContent');
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h5>Personal Information</h5>
                    <table class="table table-bordered">
                        <tr><th>Name</th><td>${application.user?.name || 'N/A'}</td></tr>
                        <tr><th>Email</th><td>${application.user?.email || 'N/A'}</td></tr>
                        <tr><th>Phone</th><td>${application.user?.phone || 'N/A'}</td></tr>
                         <tr><th>Date of Birth</th><td>${formatDate(application.DOB || application.dob)}</td></tr>
                <tr><th>Age</th><td>${application.age || calculateAge(application.DOB || application.dob) || 'N/A'}</td></tr>
                        <tr><th>Gender</th><td>${application.gender || 'N/A'}</td></tr>
                        <tr><th>Nationality</th><td>${application.nationality || 'N/A'}</td></tr>
                        <tr><th>Religion</th><td>${application.religion || 'N/A'}</td></tr>
                        <tr><th>Parents/Guardian</th><td>${application.parentsGuardianName || 'N/A'}</td></tr>
                    </table>

                    <h5 class="mt-4">Address Information</h5>
                    <h6>Permanent Address</h6>
                     <table class="table table-bordered">
                ${renderAddress(application.permanentAddress || application.permanent_Address)}
            </table>
                    <h6>Correspondence Address</h6>
                     <table class="table table-bordered">
                ${renderAddress(application.correspondenceAddress || application.correspondence_Address)}
            </table>
                </div>

                <div class="col-md-6">
                    <h5>Academic Information</h5>
                    <table class="table table-bordered">
                        <tr><th>Course</th><td>${application.course?.courseName || application.mCourse?.coursename || 'N/A'}</td></tr>
                        <tr><th>Institute</th><td>${application.course?.institute || application.mCourse?.institute || 'N/A'}</td></tr>
                        <tr><th>Status</th><td><span class="status-badge status-${application.status || 'pending'}">${(application.status || 'pending').charAt(0).toUpperCase() + (application.status || 'pending').slice(1)}</span></td></tr>
                        <tr><th>Applied Date</th><td>${formatDate(application.createdDate)}</td></tr>
                        <tr><th>Physics Score</th><td>${application.physicsScore || 'N/A'}</td></tr>
                        <tr><th>Chemistry Score</th><td>${application.chemistryScore || 'N/A'}</td></tr>
                        <tr><th>Biology Score</th><td>${application.biologyBiotechScore || 'N/A'}</td></tr>
                        <tr><th>PCB Total</th><td>${application.pcbMarks || 'N/A'}</td></tr>
                        <tr><th>NEET Score</th><td>${application.neetScore || 'N/A'}</td></tr>
                        <tr><th>Subject Choice</th><td>${application.subjectChoice || 'N/A'}</td></tr>
                    </table>

                    <h5 class="mt-4">Quota Information</h5>
                    <table class="table table-bordered">
                        <tr><th>Category</th><td>${application.cid?.categoryName || 'N/A'}</td></tr>
                        <tr><th>Management Quota</th><td>${application.managementQuota ? 'Yes' : 'No'}</td></tr>
                        <tr><th>EWS</th><td>${application.ews ? 'Yes' : 'No'}</td></tr>
                        <tr><th>Physically Challenged</th><td>${application.physicallyChallenged ? 'Yes' : 'No'}</td></tr>
                    </table>

                    <h5 class="mt-4">Documents</h5>
                    ${renderDocumentsSection(application)}
                </div>
            </div>
        `;

        // Initialize and show the modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        // Add event listeners for admin actions
        if (isAdmin) {
            document.getElementById('acceptFromPreview').addEventListener('click', () => {
                updateApplicationStatus(appId, 'accepted');
                modalInstance.hide();
            });

            document.getElementById('rejectFromPreview').addEventListener('click', () => {
                updateApplicationStatus(appId, 'rejected');
                modalInstance.hide();
            });
        }
    })
    .catch(error => {
        console.error('Error fetching application details:', error);
        showAlert('Failed to load application details', 'danger');
    });
}

// Helper function to render address
function renderAddress(address) {
    if (!address) return '<tr><td colspan="2">No address provided</td></tr>';
    return `
        <tr><th>Address Line 1</th><td>${address.addressLine1 || 'N/A'}</td></tr>
        <tr><th>Address Line 2</th><td>${address.addressLine2 || 'N/A'}</td></tr>
        <tr><th>District</th><td>${address.district?.D_name || address.district || 'N/A'}</td></tr>
        <tr><th>State</th><td>${address.state || 'N/A'}</td></tr>
        <tr><th>Pincode</th><td>${address.pincode || 'N/A'}</td></tr>
    `;
}

// Helper function to render documents section
function renderDocumentsSection(application) {
    // First check if documents exist in different possible locations
    const docs = application.documents || application;

    let html = '<div class="document-section">';

    // Define all document fields with their display names and types
    const documentFields = [
        { key: 'PassportPhoto', name: 'Passport Photo', type: 'image/jpeg' },
        { key: 'AgeProof', name: 'Age Proof', type: 'application/pdf' },
        { key: 'class10and12Marksheet', name: 'Class 10/12 Marksheet', type: 'application/pdf' },
        { key: 'class10and12certificate', name: 'Class 10/12 Certificate', type: 'application/pdf' },
        { key: 'Caste_Certificate', name: 'Caste Certificate', type: 'image/jpeg' },
        { key: 'Prc', name: 'PRC', type: 'image/jpeg' },
        { key: 'Neet_Results', name: 'NEET Results', type: 'image/jpeg' },
        { key: 'Character_Certificate', name: 'Character Certificate', type: 'image/jpeg' },
        { key: 'PWD_Certificate', name: 'PWD Certificate', type: 'image/jpeg' }
    ];

    // Process each document type
    documentFields.forEach(doc => {
        const docData = docs[doc.key];
        if (docData) {
            const url = createDocumentUrl(docData, doc.type);

            // Special handling for passport photo (show thumbnail)
            if (doc.key === 'PassportPhoto') {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">${doc.name}</div>
                        <div class="card-body">
                            <img src="${url}" class="img-thumbnail" style="max-height: 150px;">
                            <div class="mt-2">
                                <a href="${url}" class="btn btn-sm btn-primary" target="_blank">View</a>
                                <a href="${url}" class="btn btn-sm btn-secondary" download="${doc.name.replace(/\s+/g, '_').toLowerCase()}.jpg">Download</a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Standard document display
                html += `
                    <div class="card mb-3">
                        <div class="card-header">${doc.name}</div>
                        <div class="card-body">
                            ${renderDocumentPreview(url, doc.name, doc.type)}
                        </div>
                    </div>
                `;
            }
        }
    });

    // Show message if no documents found
    if (html === '<div class="document-section">') {
        html += '<div class="alert alert-info">No documents uploaded</div>';
    }

    html += '</div>';
    return html;
}

// Helper function to create document URLs
function createDocumentUrl(byteArray, contentType = 'application/pdf') {
    if (!byteArray) return null;
    if (typeof byteArray === 'string') return byteArray; // Already a URL

    // Convert byte array to Blob URL
    try {
        const blob = new Blob([new Uint8Array(byteArray)], { type: contentType });
        return URL.createObjectURL(blob);
    } catch (e) {
        console.error('Error creating document URL:', e);
        return null;
    }
}

// Helper function to render document previews
function renderDocumentPreview(url, title, type) {
    if (!url) return '<div class="text-danger">Document not available</div>';

    const isImage = type.startsWith('image/');
    const isPDF = type === 'application/pdf';
    const fileName = title.replace(/\s+/g, '_').toLowerCase() +
                     (isPDF ? '.pdf' : isImage ? '.jpg' : '');

    if (isImage) {
        return `
            <img src="${url}" class="img-thumbnail" style="max-height: 150px;">
            <div class="mt-2">
                <a href="${url}" class="btn btn-sm btn-primary" target="_blank">View</a>
                <a href="${url}" class="btn btn-sm btn-secondary" download="${fileName}">Download</a>
            </div>
        `;
    } else if (isPDF) {
        return `
            <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark-pdf fs-1 text-danger me-3"></i>
                <div>
                    <p class="mb-1">${title}</p>
                    <a href="${url}" class="btn btn-sm btn-primary me-2" target="_blank">View PDF</a>
                    <a href="${url}" class="btn btn-sm btn-secondary" download="${fileName}">Download</a>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark fs-1 text-primary me-3"></i>
                <div>
                    <p class="mb-1">${title}</p>
                    <a href="${url}" class="btn btn-sm btn-primary me-2" target="_blank">View Document</a>
                    <a href="${url}" class="btn btn-sm btn-secondary" download="${fileName}">Download</a>
                </div>
            </div>
        `;
    }
}

// Helper function to render different document types
function renderDocumentPreview(url, title) {
    if (!url) return '<div class="text-danger">Document not available</div>';

    if (url.startsWith('data:image') || url.startsWith('blob:') || typeof url === 'object') {
        return `
            <img src="${url}" class="img-thumbnail" style="max-height: 150px;">
            <div class="mt-2">
                <a href="${url}" class="btn btn-sm btn-primary" target="_blank">View</a>
                <a href="${url}" class="btn btn-sm btn-secondary" download="${title.replace(/\s+/g, '_').toLowerCase()}.jpg">Download</a>
            </div>
        `;
    } else if (url.startsWith('data:application/pdf') || url.startsWith('blob:')) {
        return `
            <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark-pdf fs-1 text-danger me-3"></i>
                <div>
                    <p class="mb-1">${title}</p>
                    <a href="${url}" class="btn btn-sm btn-primary me-2" target="_blank">View PDF</a>
                    <a href="${url}" class="btn btn-sm btn-secondary" download="${title.replace(/\s+/g, '_').toLowerCase()}.pdf">Download</a>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark fs-1 text-primary me-3"></i>
                <div>
                    <p class="mb-1">${title}</p>
                    <a href="${url}" class="btn btn-sm btn-primary me-2" target="_blank">View Document</a>
                    <a href="${url}" class="btn btn-sm btn-secondary" download="${title.replace(/\s+/g, '_').toLowerCase()}">Download</a>
                </div>
            </div>
        `;
    }
}
    // Setup modal events
    function setupModalEvents() {
        document.getElementById('acceptFromPreview').addEventListener('click', function() {
            const appId = parseInt(this.getAttribute('data-id'));
            updateApplicationStatus(appId, 'accepted');
            bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
        });

        document.getElementById('rejectFromPreview').addEventListener('click', function() {
            const appId = parseInt(this.getAttribute('data-id'));
            updateApplicationStatus(appId, 'rejected');
            bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
        });
    }

    async function loadCoursesForDropdown() {
    try {
        const response = await fetch('/courses', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            }
        });

        if (!response.ok) throw new Error('Failed to load courses');

        const courses = await response.json();
        const select = document.getElementById('courseSelect');

        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.courseid || course.id;
            option.textContent = `${course.coursename || course.name} - ${course.institute}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading courses:', error);
        showAlert('Failed to load course list', 'warning');
    }
}

// Modified uploadAdvertisement function
// Upload admission function with duplicate prevention
let isUploading = false; // Track upload state

function uploadAdmission() {
    if (isUploading) return; // Prevent multiple submissions

    const formData = new FormData();
    const admissionNo = document.getElementById('admissionNo').value;
    const admissionDate = document.getElementById('admissionDate').value;
    const admissionDescription = document.getElementById('admissionDescription').value;
    const admissionOpenDate = document.getElementById('admissionOpenDate').value;
    const admissionEndDate = document.getElementById('admissionEndDate').value;
    const admissionFile = document.getElementById('admissionFile').files[0];
    const courseId = document.getElementById('admissionCourseSelect').value;

    // Validate required fields
    if (!admissionNo || !admissionDate || !admissionDescription ||
        !admissionOpenDate || !admissionEndDate || !admissionFile || !courseId) {
        showAlert('Please fill all required fields and select a file and course', 'danger');
        return;
    }

    // Add form data
    formData.append('dtype', 'NOTIFICATION');
    formData.append('dNo', admissionNo);
    formData.append('dDate', admissionDate);
    formData.append('dDesc', admissionDescription);
    formData.append('opendate', admissionOpenDate);
    formData.append('enddate', admissionEndDate);
    formData.append('file', admissionFile);
    formData.append('courseid', courseId);

    // Show loading state
    const submitBtn = document.querySelector('#admissionForm button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';

    isUploading = true; // Set uploading flag

    // Send to server
    fetch('/api/documents/upload', {
        method: 'POST',
        body: formData,
        headers: {
            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
        }
    })
    .then(response => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Upload Admission Notice';
        isUploading = false; // Reset uploading flag

        if (!response.ok) {
            return response.text().then(text => { throw new Error(text || 'Upload failed'); });
        }
        return response.json();
    })
    .then(data => {
        // Reset form
        document.getElementById('admissionForm').reset();
        document.getElementById('admissionCourseSelect').value = '';

        // Show success message
        showAlert('Admission notice uploaded successfully!', 'success');

        // Add to activity log
        addActivity(`New admission notice uploaded for course ID ${courseId}: ${admissionNo}`);
    })
    .catch(error => {
        console.error('Upload error:', error);
        showAlert(`Upload failed: ${error.message}`, 'danger');
        isUploading = false; // Reset uploading flag on error
    });
}

// Initialize admission form - ensure this runs only once
function initAdmissionForm() {
    // Remove any existing event listeners first
    const form = document.getElementById('admissionForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    // Add new event listener
    document.getElementById('admissionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadAdmission();
    });
}

document.addEventListener('DOMContentLoaded', () => {
    // Load courses for both dropdowns
    loadCoursesForDropdown('courseSelect'); // For advertisements
    loadCoursesForDropdown('admissionCourseSelect'); // For admissions

    // Initialize form
    initAdmissionForm();
});
// Modified course loading function
async function loadCoursesForDropdown(selectId) {
    try {
        const response = await fetch('/courses', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            }
        });

        if (!response.ok) throw new Error('Failed to load courses');

        const courses = await response.json();
        const select = document.getElementById(selectId);

        // Clear existing options except the first one
        while (select.options.length > 1) {
            select.remove(1);
        }

        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.courseid;
            option.textContent = `${course.coursename} - ${course.institute}`;
            select.appendChild(option);
        });

        // Enable the select if it was disabled
        select.disabled = false;

    } catch (error) {
        console.error('Error loading courses:', error);
        showAlert('Failed to load course list. Please try again later.', 'warning');
        document.getElementById(selectId).disabled = true;
    }
}

    // Load activities
    function loadActivities() {
        // In a real app, you would fetch this from your API
        const mockActivities = [
            { message: "System updated to version 2.0", time: "2 hours ago" },
            { message: "New advertisement uploaded: ADVT-2023-001", time: "5 hours ago" },
            { message: "Application #1234 was accepted", time: "1 day ago" },
            { message: "User admin@example.com logged in", time: "1 day ago" }
        ];

        const activityList = document.getElementById('activityList');
        mockActivities.forEach(activity => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${activity.message}</span>
                <small class="text-muted">${activity.time}</small>
            `;
            activityList.appendChild(li);
        });
    }

    // Add activity to log
    function addActivity(message) {
        const now = new Date();
        const timeString = formatTimeDifference(now);

        const activityList = document.getElementById('activityList');
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span>${message}</span>
            <small class="text-muted">Just now</small>
        `;

        // Insert at the top
        if (activityList.firstChild) {
            activityList.insertBefore(li, activityList.firstChild);
        } else {
            activityList.appendChild(li);
        }

        // Update time display after a minute
        setTimeout(() => {
            li.querySelector('small').textContent = '1 minute ago';
        }, 60000);
    }

    // Format time difference
    function formatTimeDifference(date) {
        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return "Just now";
        if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;

        const days = Math.floor(hours / 24);
        return `${days} day${days === 1 ? '' : 's'} ago`;
    }

let generatedReports = []; // Track all generated reports

function initReportsSection() {
    console.log('Initializing reports section...');

    // First ensure courses are loaded
    if (!courses || courses.length === 0) {
        loadCourses().then(() => {
            populateReportCourseDropdown();
            setupReportEventListeners();
        });
    } else {
        populateReportCourseDropdown();
        setupReportEventListeners();
    }
}

function populateReportCourseDropdown() {
    const select = document.getElementById('reportCourseSelect');
    if (!select) {
        console.error('reportCourseSelect element not found!');
        return;
    }

    select.innerHTML = '<option value="">-- Select Course --</option>';

    if (!courses || courses.length === 0) {
        console.warn('No courses available to populate dropdown');
        const option = document.createElement('option');
        option.textContent = 'No courses available - please refresh';
        option.disabled = true;
        select.appendChild(option);
        return;
    }

    courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course.courseid || course.id;
        option.textContent = course.coursename || course.name;
        select.appendChild(option);
    });
}

function setupReportEventListeners() {
    const courseSelect = document.getElementById('reportCourseSelect');
    const instituteSelect = document.getElementById('reportInstituteSelect');
    const generateBtn = document.getElementById('generateMeritListBtn');

    if (!courseSelect || !instituteSelect || !generateBtn) return;

    courseSelect.addEventListener('change', function() {
        const course = courses.find(c => (c.courseid || c.id) == this.value);
        instituteSelect.innerHTML = '<option value="">-- Select Institute --</option>';

        if (course) {
            const option = document.createElement('option');
            option.value = course.institute || '';
            option.textContent = course.institute || 'Unknown Institute';
            instituteSelect.appendChild(option);
        }

        instituteSelect.disabled = !this.value;
        generateBtn.disabled = true;
    });

    instituteSelect.addEventListener('change', function() {
        generateBtn.disabled = !this.value;
    });

    generateBtn.addEventListener('click', function() {
        const courseId = courseSelect.value;
        if (courseId) generateMeritList(courseId);
    });
}

// ==================== MERIT LIST FUNCTIONS ====================

async function generateMeritList(courseId) {
    const generateBtn = document.getElementById('generateMeritListBtn');
    const originalText = generateBtn.innerHTML;

    try {
        // Show loading state
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

        // Get course details
        const course = courses.find(c => (c.courseid || c.id) == courseId);
        if (!course) {
            throw new Error('Course not found');
        }

        // Get ALL applications first
        const allAppsResponse = await fetch(`/application/applications?courseId=${courseId}`, {
            credentials: 'include'
        });
        if (!allAppsResponse.ok) throw new Error('Failed to fetch applications');
        const allApplications = await allAppsResponse.json();

        // Filter to only accepted applications
        const acceptedApplications = allApplications.filter(app =>
            (app.status || '').toLowerCase() === 'accepted'
        );

        if (acceptedApplications.length === 0) {
            throw new Error('No accepted applications found for this course');
        }

        // Process applications and generate report
        const finalMeritList = processApplications(acceptedApplications, course);
        await showMeritListModal(finalMeritList, course);

        // Add to recent reports
        const report = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            courseId: courseId,
            courseName: course.coursename || course.name,
            institute: course.institute,
            type: 'Merit List',
            data: finalMeritList
        };
        generatedReports.unshift(report);
        updateRecentReportsTable();

    } catch (error) {
        console.error('Error generating merit list:', error);
        showAlert(`Failed to generate merit list: ${error.message}`, 'danger');
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
    }
}

function processApplications(applications, course) {
    // First, ensure all applications have the required fields
    const validatedApps = applications.map(app => ({
        id: app.id,
        applicantName: app.applicantName || 'Unknown',
        category: app.category || 'General',
        neetScore: parseFloat(app.neetScore) || 0,
        quota: app.quota || (app.managementQuota ? 'Management' : 'Regular'),
        status: app.status || 'accepted',
        appliedDate: app.appliedDate
    }));

    // Sort by NEET score (descending), then by application date (earlier first)
    validatedApps.sort((a, b) => {
        if (b.neetScore !== a.neetScore) {
            return b.neetScore - a.neetScore;
        }
        return new Date(a.appliedDate) - new Date(b.appliedDate);
    });

    // Get quota configuration
    const quotaConfig = getQuotaConfig(course.coursename || course.name, course.institute);

    // Initialize categories
    const categorized = {
        garo: [], khasi_jaintia: [], general_ur: [],
        osc_ost: [], management: [], nri: [], remaining: []
    };

    // Categorize applications
    validatedApps.forEach(app => {
        if (app.quota.toLowerCase() === 'management') {
            categorized.management.push(app);
            return;
        }
        if (app.quota.toLowerCase() === 'nri') {
            categorized.nri.push(app);
            return;
        }

        switch ((app.category || '').toLowerCase()) {
            case 'garo': categorized.garo.push(app); break;
            case 'khasi':
            case 'jaintia': categorized.khasi_jaintia.push(app); break;
            case 'general':
            case 'ur': categorized.general_ur.push(app); break;
            case 'osc':
            case 'ost': categorized.osc_ost.push(app); break;
            default: categorized.remaining.push(app);
        }
    });

    // Select candidates based on quotas
    const selectedCandidates = [
        ...categorized.garo.slice(0, quotaConfig.garo),
        ...categorized.khasi_jaintia.slice(0, quotaConfig.khasi_jaintia),
        ...categorized.general_ur.slice(0, quotaConfig.general_ur),
        ...categorized.osc_ost.slice(0, quotaConfig.osc_ost),
        ...categorized.management.slice(0, quotaConfig.management),
        ...categorized.nri.slice(0, quotaConfig.nri),
        ...categorized.remaining.slice(0, quotaConfig.remaining)
    ];

    // Final sort by NEET score
    return selectedCandidates.sort((a, b) => b.neetScore - a.neetScore);
}

function getQuotaConfig(courseName, institute) {
    const config = {
        garo: 0, khasi_jaintia: 0, general_ur: 0,
        osc_ost: 0, management: 0, nri: 0, remaining: 0
    };

    courseName = (courseName || '').toLowerCase();
    institute = (institute || '').toLowerCase();

    if (courseName === 'mbbs') {
        if (institute === 'smc') {
            config.garo = 17; config.khasi_jaintia = 17; config.general_ur = 6;
            config.osc_ost = 2; config.management = 63; config.nri = 23; config.remaining = 8;
        } else if (institute === 'pimc') {
            config.garo = 26; config.khasi_jaintia = 26; config.general_ur = 9;
            config.osc_ost = 3; config.management = 63; config.nri = 23;
        }
    } else if (courseName === 'bams' && institute === 'pimc') {
        config.garo = 11; config.khasi_jaintia = 11; config.general_ur = 4;
        config.osc_ost = 2; config.management = 28; config.nri = 14;
    }

    return config;
}

async function showMeritListModal(meritList, course) {
    return new Promise((resolve) => {
        try {
            // Create or get modal
            let modal = document.getElementById('meritListModal');

            // Remove existing modal if it exists
            if (modal) {
                modal.remove();
            }

            // Create new modal
            modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'meritListModal';
            modal.tabIndex = '-1';
            modal.setAttribute('aria-labelledby', 'meritListModalLabel');
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="meritListModalLabel">
                                Merit List for ${course.coursename || course.name} - ${course.institute}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Application ID</th>
                                            <th>Name</th>
                                            <th>Category</th>
                                            <th>NEET Score</th>
                                            <th>Quota</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="meritListTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="exportMeritListBtn">
                                <i class="bi bi-download"></i> Export as PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Populate table
            const tableBody = modal.querySelector('#meritListTableBody');
            meritList.forEach((app, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${app.id || 'N/A'}</td>
                    <td>${app.applicantName || 'N/A'}</td>
                    <td>${app.category || 'N/A'}</td>
                    <td>${app.neetScore || 'N/A'}</td>
                    <td>${app.managementQuota ? 'Management' : app.domicile === 'nri' ? 'NRI' : 'Regular'}</td>
                    <td><span class="badge bg-success">Selected</span></td>
                `;
                tableBody.appendChild(row);
            });

            // Initialize modal
            const modalInstance = new bootstrap.Modal(modal, {
                backdrop: true,
                keyboard: true,
                focus: true
            });

            // Show modal
            modalInstance.show();

            // Handle export button
            modal.querySelector('#exportMeritListBtn').addEventListener('click', async () => {
                await exportMeritListAsPDF(meritList, course);
            });

            // Handle modal hidden event
            modal.addEventListener('hidden.bs.modal', () => {
                modalInstance.dispose();
                modal.remove();
                resolve();
            });

        } catch (error) {
            console.error('Error displaying merit list:', error);
            showAlert('Failed to display merit list', 'danger');
            resolve();
        }
    });
}

async function exportMeritListAsPDF(meritList, course) {
    try {
        // Check if jsPDF is available (with fallback)
        if (typeof window.jspdf !== 'undefined') {
            const { jsPDF } = window.jspdf;
            return generatePDFWithJSPDF(jsPDF, meritList, course);
        } else if (typeof jsPDF !== 'undefined') {
            return generatePDFWithJSPDF(jsPDF, meritList, course);
        } else {
            // Fallback to server-side PDF generation or download as CSV
            return fallbackExport(meritList, course);
        }
    } catch (error) {
        console.error('Error exporting PDF:', error);
        showAlert('Failed to export PDF: ' + error.message, 'danger');
        // Try fallback method
        return fallbackExport(meritList, course);
    }
}

function generatePDFWithJSPDF(jsPDF, meritList, course) {
    return new Promise((resolve) => {
        try {
            // Create PDF document
            const doc = new jsPDF({
                orientation: 'landscape'
            });

            // Add title
            doc.setFontSize(16);
            doc.text(`Merit List for ${course.coursename || course.name} - ${course.institute}`, 14, 15);

            // Add generation date
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);

            // Create table data
            const headers = [
                'Rank',
                'Application ID',
                'Name',
                'Category',
                'NEET Score',
                'Quota',
                'Status'
            ];

            const data = meritList.map((app, index) => [
                index + 1,
                app.id || 'N/A',
                app.applicantName || 'N/A',
                app.category || 'N/A',
                app.neetScore || 'N/A',
                app.managementQuota ? 'Management' : app.domicile === 'nri' ? 'NRI' : 'Regular',
                'Selected'
            ]);

            // Add table to PDF
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 30,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 20 }
                }
            });

            // Save PDF
            doc.save(`merit-list-${course.coursename || course.name}-${new Date().toISOString().slice(0, 10)}.pdf`);
            resolve();
        } catch (error) {
            console.error('Error generating PDF:', error);
            showAlert('Failed to generate PDF: ' + error.message, 'danger');
            resolve();
        }
    });
}

async function fallbackExport(meritList, course) {
    try {
        // First try server-side PDF generation
        const response = await fetch('/api/generate-merit-list-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                course,
                meritList
            }),
            credentials: 'include'
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `merit-list-${course.coursename || course.name}-${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            return;
        }

        // If server-side fails, fall back to CSV
        showAlert('PDF generation failed. Downloading as CSV instead.', 'warning');
        exportAsCSV(meritList, course);
    } catch (error) {
        console.error('Fallback export failed:', error);
        showAlert('Failed to generate PDF. Downloading as CSV instead.', 'warning');
        exportAsCSV(meritList, course);
    }
}

function exportAsCSV(meritList, course) {
    try {
        // CSV header
        let csv = 'Rank,Application ID,Name,Category,NEET Score,Quota,Status\n';

        // Add data rows
        meritList.forEach((app, index) => {
            csv += `${index + 1},`;
            csv += `${app.id || 'N/A'},`;
            csv += `${app.applicantName || 'N/A'},`;
            csv += `${app.category || 'N/A'},`;
            csv += `${app.neetScore || 'N/A'},`;
            csv += `${app.managementQuota ? 'Management' : app.domicile === 'nri' ? 'NRI' : 'Regular'},`;
            csv += 'Selected\n';
        });

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `merit-list-${course.coursename || course.name}-${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error exporting CSV:', error);
        showAlert('Failed to export data in any format. Please try again later.', 'danger');
    }
}

function updateRecentReportsTable() {
    const tableBody = document.getElementById('recentReportsTable');
    if (!tableBody) return;

    tableBody.innerHTML = generatedReports.length ? '' : `
        <tr><td colspan="5" class="text-center py-4">No reports generated yet</td></tr>
    `;

    generatedReports.forEach(report => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${report.date}</td>
            <td>${report.courseName}</td>
            <td>${report.institute}</td>
            <td>${report.type}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary view-report-btn" data-report-id="${report.id}">
                    <i class="bi bi-eye"></i> View
                </button>
                <button class="btn btn-sm btn-outline-secondary download-report-btn" data-report-id="${report.id}">
                    <i class="bi bi-download"></i> PDF
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });

    // Add event listeners
    document.querySelectorAll('.view-report-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const report = generatedReports.find(r => r.id == btn.dataset.reportId);
            if (report) showMeritListModal(report.data, {
                coursename: report.courseName,
                institute: report.institute
            });
        });
    });

    document.querySelectorAll('.download-report-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const report = generatedReports.find(r => r.id == btn.dataset.reportId);
            if (report) exportMeritListAsPDF(report.data, {
                coursename: report.courseName,
                institute: report.institute
            });
        });
    });
};
</script>
</body>
</html>